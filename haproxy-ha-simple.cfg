global
    daemon
    maxconn 256
    log stdout local0

defaults
    mode tcp
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    option tcplog

# Docker DNS resolver so backend names can disappear/reappear without blocking startup
resolvers docker
    nameserver dns 127.0.0.11:53
    resolve_retries 3
    timeout resolve 1s
    timeout retry 1s
    hold other 30s
    hold refused 30s
    hold nx 30s
    hold timeout 30s
    hold valid 10s

# HAProxy Statistics
listen stats
    bind *:5000
    mode http
    stats enable
    stats uri /stats
    stats refresh 5s
    stats admin if TRUE

# PostgreSQL Cluster với health checks
listen postgres
    bind *:5432
    mode tcp
    option tcplog
    balance roundrobin
    option tcp-check
    tcp-check connect port 5432
    
    # Primary server (ưu tiên cao)
    server postgres-primary postgres-primary:5432 check port 5432 inter 3s rise 2 fall 3 weight 100 resolvers docker resolve-prefer ipv4 init-addr none
    
    # Replica server (backup, sẽ được promote khi Primary down)
    server postgres-replica-1 postgres-replica-1:5432 check port 5432 inter 3s rise 2 fall 3 weight 50 backup resolvers docker resolve-prefer ipv4 init-addr none

# Health check endpoint
listen health
    bind *:8080
    mode http
    option httpchk GET /health
    http-check expect status 200




