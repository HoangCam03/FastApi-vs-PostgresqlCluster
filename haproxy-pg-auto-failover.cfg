global
    daemon
    maxconn 256
    log stdout local0

defaults
    mode tcp
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    option tcplog

# Docker DNS resolver to keep HAProxy running when a backend name is missing
resolvers docker
    nameserver dns 127.0.0.11:53
    resolve_retries 3
    timeout resolve 1s
    timeout retry 1s
    hold other 30s
    hold refused 30s
    hold nx 30s
    hold timeout 30s
    hold valid 10s

# HAProxy Statistics
listen stats
    bind *:5000
    mode http
    stats enable
    stats uri /stats
    stats refresh 5s
    stats admin if TRUE

# PostgreSQL Cluster với pg_auto_failover integration
listen postgres
    bind *:5432
    mode tcp
    option tcplog
    balance roundrobin
    option tcp-check
    tcp-check connect port 5432
    
    # Primary server (tự động được promote bởi pg_auto_failover)
    server postgres-primary postgres-primary:5432 check port 5432 inter 2s rise 1 fall 1 weight 100 resolvers docker resolve-prefer ipv4 init-addr none
    
    # Replica server (sẽ được promote thành primary khi primary down)
    server postgres-replica-1 postgres-replica-1:5432 check port 5432 inter 2s rise 1 fall 1 weight 50 resolvers docker resolve-prefer ipv4 init-addr none

# Health check endpoint cho pg_auto_failover
listen health
    bind *:8080
    mode http
    option httpchk GET /health
    http-check expect status 200
